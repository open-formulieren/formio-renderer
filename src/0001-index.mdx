import {Meta} from '@storybook/addon-docs/blocks';

<Meta title="Introduction" />

# Open Forms' Formio Renderer

`@open-formulieren/formio-renderer` is a pure React based renderer for Formio form definitions.

## Quickstart

**NOTE** - this library is still in active development and public API _may_ change.

**High level API**

There is one public component available - it renders a form given a Formio definition.

```tsx
import {FormioForm} from '@open-formulieren/formio-renderer';
import '@open-formulieren/formio-renderer/formio-renderer.css';
import type {ValidatePluginCallback} from '@open-formulieren/formio-renderer/validationSchema';
import {IntlProvider} from 'react-intl';

const FORMIO_FORM = {
  display: 'form',
  components: [
    {
      id: '123',
      type: 'textfield',
      key: 'someTextfield',
      label: 'Some textfield',
      defaultValue: 'a default value',
      validate: {
        required: true,
        maxLength: 100,
      },
    },
  ],
};

// Example callback
const validatePluginCallback: ValidatePluginCallback = async (plugin: string, value: JSONValue) => {
  if (plugin === 'mock') {
    if (value === 'invalid') {
      return {
        valid: false,
        messages: ['Error message 1.', 'Second error message.'],
      };
    }
  }
  return {valid: true};
};

const MyComponent: React.FC = () => (
  // there must be an outer IntlProvider - it's your responsibility to set this up properly
  <IntlProvider messages={{}} locale="nl" defaultLocale="nl">
    <FormioForm
      components={FORMIO_FORM.components}
      onChange={values => console.log(values)}
      onSubmit={values => console.log(values)}
      id="my-formio-form"
      requiredFieldsWithAsterisk
      componentParameters={{
        addressNL: {addressAutoComplete},
        file: {upload, destroy},
      }}
      validatePluginCallback={validatePluginCallback}
    />
    <button type="submit" form="my-formio-form">
      Submit
    </button>
  </IntlProvider>
);
```

- We only support react-intl for translations.
- The `onSubmit` callback receives the submission data values as sole argument.
- You must pass at least a submit button in the children - you can provide more elements in case you
  need a button toolbar (like the SDK does).

**Low level API**

The high level API is built with a number of low level API components that you can use to render
Formik-based forms without Formio requirements.

```tsx
import {
  Checkbox,
  DateField,
  HelpText,
  InputContainer,
  Label,
  NumberField,
  RadioField,
  SelectField,
  TextField,
  ValidationErrors,
} from '@open-formulieren/formio-renderer';
```

## Why does this exist?

Open Forms has used [Formio](https://github.com/formio/formio.js/) since its inception, and probably
wouldn't be as adopted as it is without Formio. We're extremely thankfull that this solution is
available as Open Source software.

However, the way we use Formio as part of a larger software ("Open Forms") shows that it's not a
perfect fit to be able to implement all the features we need. We have build _a lot_ of things around
or on top of Formio with particular form flows and tight integration with Dutch government systems.

On top of that, we only expose (and officially) support a small subset of the myriad of features
that Formio has, with quite a different approach to themes/styling/templating and we really like
using React for our SPA-like application/frontend development. To summarize - we need to use in very
specific ways and that doesn't work well with how _we_ would like to do things.

So, we have decided to stick to the Formio principles of configuring forms as JSON definitions and
aim for compatibility with their SDK as a reference implementations on existing features that we
re-implement. There are some deviations in places where we think that Formio got things wrong, and
we have a number of extensions. This library is built to accomodate that in a way that provides a
good developer experience and a great user experience for people using the forms built with Open
Forms.

## Roadmap

See [Github](https://github.com/open-formulieren/open-forms/issues/5133)

## Design goals

We're building this library to solve some specific problems, captured in the design goals listed
below.

**It must solve "Open Forms problems"**

Open Forms uses Formio, not the other way around. When conflicts arise between Open Forms' needs and
the reference SDK implementation we pick the solution that benefits Open Forms. Being able to use
form definitions from Formio.js in Open Forms in a nice to have, but no hard requirement.

That said - it must be a last resort if it cannot be reasonably solved in a compatible way. We also
try to properly namespace Open Forms' specific extensions to maintain compatibility (best effort).

**End-users must have a performant and accessible solution**

A snappy UI that is properly localized/translated and supports assistive technology out of the box
is essential.

Users don't fill out forms for fun, it is typically a chore - let's try to make the experience as
positive as it can be.

**Developer experience**

Formio's codebase is vast and requires quite a bit of knowledge before you can properly start
hacking on it and make the correct implementation choices. In thise codebase, we want to make
extending and/or modifying the behaviour of a specific component straight forward and easy to get
started with.

- You shouldn't need to know more than React and HTML to get started.
- Typescript to catch type errors at compile time - we ensure you can reason about a strict
  component schema.
- Generic code is abstracted away and (try to) avoid leaky abstractions.

The code base is structured so that:

- `components` contains pure React components, with varying complexity.
- `registry` contains a directory for each supported Formio component type where the behaviour for
  that component type is implemented (completely). They can be and are tested in isolation.
- we build on top of `@open-formulieren/types` so that we only worry about the features that Open
  Forms provides/supports.

## Design decisions

Decisions made while ipmlementing the renderer.

**Backend API interaction**

While the renderer is (in practice) paired with the backend API of Open Forms, this connection is
implicit and indirect. The [SDK](https://github.com/open-formulieren/open-forms-sdk) is responsible
for the backend API interaction and is the caller of the renderer. The renderer is not allowed to
directly consume API resources.

Instead, we apply some form of "dependency injection" that's purely callback/configuration based,
where the SDK provides handlers that the renderer expects.

**Component-specific functionalities are shared through React context**

Most components (Formio-component types) only need their local configuration, but some are more
complex and require additional information, e.g.:

- file upload components need an endpoint to upload to (and authentication details)
- async backend validators need to call the endpoint during validation
- `addressNL` needs to call the BAG-APIs to perform address lookups
- `email` verification needs a verification flow and dedicated endpoints + state

With a top-level API around the `FormioForm` and a `FormSettingsProvider` context, we expose a high
level and a low level API for the SDK to pass this additional configuration.

- Each component type in the `src/registry` owns the type definitions of the additional context.
- Each component must handle the case where this configuration is _not_ available.
- The configuration is tracked in the `FormSettings` context under the `componentParameters`
  property, where the parameters are namespaced with each `component.type` key.
